---
title: "Naissance"
author: "Eagle IO"
date: "1/14/2021"
output: pdf_document
---

```{r,echo=FALSE,include=FALSE}
library(readxl)
library(tidyverse)
library(stringr)
library(psych)
library(caret)
library(ggplot2)
library(car)
library(ggthemes)
library(plyr)
library(scales)
library(zoo)
library(descr)
library(dplyr)
library(tidymodels)
library(class)
library(kknn)
library(janitor)
library(CGPfunctions)
library(summarytools)
library(ggpubr)
library(stringi)
library(hrbrthemes)
library(tidyr)
library(viridis)
library(e1071)
library(moments)
library(rstatix)

# Remember to change the location to your computer or flashdrive. 
data <- read_excel("E:/Montclair State University/EagleIO/Naissance/Naissance e-Mail Metrics Pilot - Data Template.xlsx")
```

```{r, include=FALSE}
#Cleaning up
Date<-as.data.frame(substr(data$`Send Time`,1,10))
Time<-as.data.frame(substr(data$`Send Time`,12,19))

#Rename Days and Time

Date<-Date%>%dplyr::rename(date="substr(data$`Send Time`, 1, 10)")
Time<-Time%>%dplyr::rename(time="substr(data$`Send Time`, 12, 19)")

Date$date<-gsub("2021","2020",Date$date)

# Creating Days
Date2<-as.data.frame(weekdays(as.Date(Date$date,'%Y-%m-%d')))
Date2<-Date2%>%dplyr::rename(date='weekdays(as.Date(Date$date, "%Y-%m-%d"))')

# Creating Months
Month<-as.data.frame(months(as.Date(Date$date,'%Y-%m-%d')))
Month<-Month%>%dplyr::rename(month=`months(as.Date(Date$date, "%Y-%m-%d"))`)

# Creating Week
Date$date<-as.Date(Date$date)
Week<-as.data.frame(stringi::stri_datetime_fields(Date$date)$WeekOfMonth)
Week<-Week%>%dplyr::rename(week="stringi::stri_datetime_fields(Date$date)$WeekOfMonth")
  
# Combining
Data2<-data%>%select(ID,`Reference / Name`:`Unsubscribe Rate`)

Data2<-cbind(Date2,Time, Month,Week,Data2)

Data2<-Data2%>%select(ID,date:week,`Reference / Name`:`Unsubscribe Rate`)

```

```{r}
# Basic Desciptives
summary(Data2)
```


```{r,echo=FALSE}
#Frequency
freq(Data2$`Reference / Name`)
freq(Data2$`From Firm?`)
freq(Data2$`e-Mail Type`)
freq(Data2$`Product Name(s) (if applicable)`)
freq(Data2$`Subscription?`)
freq(Data2$`Blast Message?`)
freq(Data2$`Distribution Partner Specific?`)
freq(Data2$`Preferred Partner?`)
freq(Data2$`Producers Only`)
freq(Data2$`Prospects Only`)
```

```{r}
#Outliers
Out.Audience.Size<-boxplot.stats(Data2$`Audience Size`)$out
Out.Open.Rate<-boxplot.stats(Data2$`Open Rate`)$out
Out.Clickthrough.Rate<-boxplot.stats(Data2$`Clickthrough Rate`)$out
Out.Bounce.Rate<-boxplot.stats(Data2$`Bounce Rate`)$out
Out.Unsubscibe.Rate<-boxplot.stats(Data2$`Unsubscribe Rate`)$out

#Boxplot
ggplot(Data2) +
  aes(x="",y=`Audience Size`)+
  geom_boxplot(fill="#0c4c8a")+
  theme_minimal()
  
ggplot(Data2) +
  aes(x = "", y = `Open Rate`) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = "", y = `Clickthrough Rate`) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = "", y = `Bounce Rate`) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = "", y = `Unsubscribe Rate`) +
  geom_boxplot(fill = "#0c4c8a") +
  theme_minimal()

# Histograms
ggplot(Data2) +
  aes(x = `Audience Size`) +
  geom_histogram(bins = 30L, fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = `Open Rate`) +
  geom_histogram(bins = 30L, fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = `Clickthrough Rate`) +
  geom_histogram(bins = 30L, fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = `Bounce Rate`) +
  geom_histogram(bins = 30L, fill = "#0c4c8a") +
  theme_minimal()

ggplot(Data2) +
  aes(x = `Unsubscribe Rate`) +
  geom_histogram(bins = 30L, fill = "#0c4c8a") +
  theme_minimal()
```

```{r}
# QQplot
#Audience Size needs to be fixed
#qq.Audience.Size <- qqPlot(Data2$Audience.Size)
qq.Open.Rate<-qqPlot(Data2$`Open Rate`)
qq.Clickthrough.Rate<-qqPlot(Data2$`Clickthrough Rate`)
qq.Bounce.Rate<-qqPlot(Data2$`Bounce Rate`)
qq.Unsubscribe.Rate<-qqPlot(Data2$`Unsubscribe Rate`)

# Density Plot
ggdensity(Data2$`Audience Size`,
          main= "Density plot of Open Rate",
          xlab = "Audience size")

ggdensity(Data2$`Open Rate`,
          main= "Density plot of Open Rate",
          xlab= "Open Rate")

ggdensity(Data2$`Clickthrough Rate`,
          main= "Density plot of Clickthrough Rate",
          xlab= "Clickthrough Rate")

ggdensity(Data2$`Bounce Rate`,
          main= "Density plot of Bounce Rate",
          xlab= "Bounce Rate")

ggdensity(Data2$`Unsubscribe Rate`,
          main= "Density plot of Unsubscribe Rate",
          xlab= "Unsubscribe Rate")

##Shapiro-Test Wilks
shapiro.test(Data2$`Audience Size`)
shapiro.test(Data2$`Open Rate`)
shapiro.test(Data2$`Clickthrough Rate`)
shapiro.test(Data2$`Bounce Rate`)
shapiro.test(Data2$`Unsubscribe Rate`)

#Skewness
skewness(Data2$`Audience Size`,na.rm = TRUE)
skewness(Data2$`Open Rate`,na.rm = TRUE)
skewness(Data2$`Clickthrough Rate`,na.rm = TRUE)
skewness(Data2$`Bounce Rate`,na.rm = TRUE)
skewness(Data2$`Unsubscribe Rate`,na.rm = TRUE)

#kurtosis
kurtosis(Data2$`Audience Size`,na.rm = TRUE)
kurtosis(Data2$`Open Rate`,na.rm = TRUE)
kurtosis(Data2$`Clickthrough Rate`,na.rm = TRUE)
kurtosis(Data2$`Bounce Rate`,na.rm = TRUE)
kurtosis(Data2$`Unsubscribe Rate`,na.rm = TRUE)

```


```{r}
#Quantile
quantile(Data2$`Open Rate`,na.rm = TRUE)
quantile(Data2$`Clickthrough Rate`, na.rm = TRUE)
quantile(Data2$`Bounce Rate`, na.rm=TRUE)
quantile(Data2$`Unsubscribe Rate`, na.rm = TRUE)


```


```{r}
#Descriptive: mean of DVs at each level of each categorical IV
#From.Firm
Data2%>%group_by(`From Firm?`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

#email Type
Data2%>%group_by(`e-Mail Type`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

#Product Name
Data2%>%group_by(`Product Name(s) (if applicable)`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

#Subscription
Data2%>%group_by(`Subscription?`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

# Blast Message
Data2%>%group_by(`Blast Message?`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

# Distribution Partner Specific
Data2%>%group_by(`Distribution Partner Specific?`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

# Preferred Partner
Data2%>%group_by(`Preferred Partner?`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

# Producers Only 
Data2%>%group_by(`Producers Only`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

# Prospects 
Data2%>%group_by(`Prospects Only`)%>%
  dplyr::summarise(open_mean = mean(`Open Rate`),
            clickthrough_mean = mean(`Clickthrough Rate`),
            bounce_mean = mean(`Bounce Rate`),
            unsubscribe_mean = mean(`Unsubscribe Rate`),
            n())

```




```{r}
# Data visualization
ggplot(Data2, aes(time, date, fill = `Open Rate`)) +
  geom_tile(colour = "white") +
  facet_grid(week~month) +
  scale_fill_gradient(low="red", high="green") +
  labs(x="Time of Day",
       y="",
       title = "Time-Series Calendar Heatmap",
       subtitle="Email Open Rate",
       fill="Close")
#Plot 2
ggplot(Data2, aes(time, date, fill = `Clickthrough Rate`)) +
  geom_tile(colour = "white") +
  facet_grid(week~month) +
  scale_fill_gradient(low="red", high="green") +
  labs(x="Time of Day",
       y="",
       title = "Time-Series Calendar Heatmap",
       subtitle="Email Clickthrough Rate",
       fill="Close")

#Plot 3
ggplot(Data2, aes(time, date, fill = `Bounce Rate`)) +
  geom_tile(colour = "white") +
  facet_grid(week~month) +
  scale_fill_gradient(low="red", high="green") +
  labs(x="Time of Day",
       y="",
       title = "Time-Series Calendar Heatmap",
       subtitle="Email Bounce Rate",
       fill="Close")

#Plot 4
ggplot(Data2, aes(time, date, fill = `Unsubscribe Rate`)) +
  geom_tile(colour = "white") +
  facet_grid(week~month) +
  scale_fill_gradient(low="red", high="green") +
  labs(x="Time of Day",
       y="",
       title = "Time-Series Calendar Heatmap",
       subtitle="Email Unsubscribe Rate",
       fill="Close")

```

```{r}
# Regression and Machine Learning
validation_index <- createDataPartition(data$Open.Rate, p=0.80, list=FALSE)

validation <- data[-validation_index,]

dataset <- data[validation_index,]

control <- trainControl(method = "cv", 
                              number = 5,verboseIter = TRUE)
metric="RMSE"

################ Open Rate
set.seed(7)
model.knn <- train(Open.Rate~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                   + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                   + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                   + US.AUM + US.Intermediary.AUM, data=dataset, method="knn", metric=metric, trControl=control)

set.seed(9)
model.lm <- train(Open.Rate ~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                  + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                  + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                  + US.AUM + US.Intermediary.AUM, data = dataset, method = "lm", metric=metric,
                  trControl = control)
summary(model.lm)

predictions <- predict(model.lm, validation)
prediction<-as.data.frame(cbind(predictions,validation$Open.Rate))

################ Clickthrought
set.seed(7)
model.knn <- train(Clickthrought.Rate~ Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                   + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                   + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                   + US.AUM + US.Intermediary.AUM, data=dataset, method="knn", metric=metric, trControl=control)

set.seed(9)
model.lm <- train(Clickthrought.Rate ~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                  + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                  + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                  + US.AUM + US.Intermediary.AUM, data = dataset, method = "lm", metric=metric,
                  trControl = train.control)
summary(model.lm)

predictions <- predict(model.lm, validation)
confusionMatrix(predictions, validation$Clickthrought.Rate)

################ Bounce Rate
set.seed(7)
model.knn <- train(Bounce.Rate~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                   + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                   + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                   + US.AUM + US.Intermediary.AUM, data=dataset, method="knn", metric=metric, trControl=control)

set.seed(9)
model.lm <- train(Bounce.Rate ~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                  + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                  + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                  + US.AUM + US.Intermediary.AUM, data = dataset, method = "lm", metric=metric,
                  trControl = train.control)
summary(model.lm)

predictions <- predict(model.lm, validation)
confusionMatrix(predictions, validation$Bounce.Rate)

################ Unsubscribe
set.seed(7)
model.knn <- train(Unsubscribe.Rate~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                   + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                   + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                   + US.AUM + US.Intermediary.AUM, data=dataset, method="knn", metric=metric, trControl=control)

set.seed(9)
model.lm <- train(Unsubscribe.Rate ~Reference.Name + From.Firm + email.Type + Product.Name + Subscription
                  + Audience.Size + Blast.Message + Distribution.Partner.Specific + Preferred.Partner
                  + Producers.Only + Prospect.Only + AUM + Morningstar.Rating + Focus.Status 
                  + US.AUM + US.Intermediary.AUM, data = dataset, method = "lm", metric=metric,
                  trControl = train.control)
summary(model.lm)

predictions <- predict(model.lm, validation)
confusionMatrix(predictions, validation$Unsubscribe.Rate)
```

